<!DOCTYPE html>
<html>
<head>
    <title>Upload & Gắn Schema</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        body { background: #f5f5fa;}
        .main-card { background: #fff; border-radius: 16px; box-shadow:0 4px 24px rgba(0,0,0,0.06); padding: 32px; margin: 48px auto;}
        .btn { border-radius: 999px;}
        .table { background: #fff; }
        .status-ok { color: #228b22; font-weight: bold; }
        .status-fail { color: #c00; font-weight: bold; }
    </style>
</head>
<body>
<div class="container">
    <div class="main-card">
        <h2 class="mb-4">Upload file Excel để gắn/xoá Schema</h2>
        <form method="post" enctype="multipart/form-data">
            <div class="mb-3">
                <input class="form-control" type="file" name="file" accept=".xlsx" required>
            </div>
            <button class="btn btn-primary" type="submit">Tải lên</button>
            <a href="/logout" class="btn btn-secondary">Đăng xuất</a>
        </form>

        {% if table %}
            <hr>
            <h4 class="mt-4">Dữ liệu upload</h4>
            <form id="runform" method="post" action="/run-task">
                <input type="hidden" name="task_id" value="{{task_id}}">
                <button class="btn btn-success" name="action" value="chencode" type="submit" id="btn-run">Gắn Schema</button>
                <button class="btn btn-danger" name="action" value="xoascript" type="submit" id="btn-xoa">Xoá Schema</button>
            </form>
            <table class="table table-bordered mt-3" id="result-table">
                <thead class="table-light">
                    <tr>
                        <th>STT</th>
                        <th>URL</th>
                        <th>Type</th>
                        <th>Site</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                {% for row in table %}
                    <tr>
                        <td>{{loop.index}}</td>
                        <td style="font-size:13px">{{row.url}}</td>
                        <td>{{row.type}}</td>
                        <td>{{row.site}}</td>
                        <td class="status-col">{{row.status}}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const runform = document.getElementById("runform");
    if(runform){
        runform.onsubmit = async function(e) {
            e.preventDefault();
            document.getElementById("btn-run").disabled = true;
            document.getElementById("btn-xoa").disabled = true;
            let formData = new FormData(runform);
            let res = await fetch("/run-task", {method: "POST", body: formData});
            let data = await res.json();
            // Update table
            let tbody = document.querySelector("#result-table tbody");
            tbody.innerHTML = "";
            data.table.forEach((row, idx) => {
                let statusClass = row.status.includes('✅') ? "status-ok" : (row.status.includes('❌') ? "status-fail" : "");
                tbody.innerHTML += `<tr>
                    <td>${idx+1}</td>
                    <td style="font-size:13px">${row.url}</td>
                    <td>${row.type}</td>
                    <td>${row.site}</td>
                    <td class="status-col ${statusClass}">${row.status}</td>
                </tr>`;
            });
            document.getElementById("btn-run").disabled = false;
            document.getElementById("btn-xoa").disabled = false;
        }
    }
});
</script>
</body>
</html>
