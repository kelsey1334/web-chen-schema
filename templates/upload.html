<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Schema Tool - Upload</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/main.css">
    <style>
        td.status-success { color: green; font-weight: bold; }
        td.status-fail { color: red; font-weight: bold; }
        td.status-processing { color: orange; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">Schema Tool</a>
            <div>
                <a href="/logout" class="btn btn-outline-secondary btn-sm">Đăng xuất</a>
            </div>
        </div>
    </nav>
    <div class="container py-4">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h4 class="mb-3">Upload File Excel</h4>
                <form method="post" action="/upload" enctype="multipart/form-data" class="row g-3">
                    <div class="col-md-6">
                        <input type="file" name="file" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                        <select name="action" class="form-select">
                            <option value="chencode" {% if action=="chencode" %}selected{% endif %}>Gắn Schema</option>
                            <option value="xoascript" {% if action=="xoascript" %}selected{% endif %}>Xoá Schema</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-grid">
                        <button class="btn btn-success">Upload</button>
                    </div>
                </form>
                {% if error %}
                    <div class="alert alert-danger mt-2">{{ error }}</div>
                {% endif %}
            </div>
        </div>
        {% if preview_rows %}
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="mb-3">Preview dữ liệu (tối đa 100 dòng đầu)</h5>
                <div class="table-responsive">
                    <table class="table table-bordered align-middle" id="preview-table">
                        <thead>
                            <tr>
                                <th>STT</th>
                                {% for c in cols %}
                                <th>{{ c }}</th>
                                {% endfor %}
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in preview_rows %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                {% for c in cols %}
                                <td>{{ row[c] }}</td>
                                {% endfor %}
                                <td class="status" data-status="">Chưa chạy</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <button id="run-btn" class="btn btn-primary mt-3">Bắt đầu {{ 'gắn' if action=="chencode" else 'xoá' }} schema</button>
            </div>
        </div>
        {% endif %}
    </div>
    <script>
        const runBtn = document.getElementById("run-btn");
        if(runBtn){
            runBtn.onclick = async function(){
                const table = document.getElementById("preview-table");
                runBtn.disabled = true;
                for(let i=1; i<table.rows.length; ++i){
                    const row = table.rows[i];
                    let cells = Array.from(row.cells);
                    let rowData = {};
                    {% for idx,c in enumerate(cols) %}
                    rowData["{{c}}"] = cells[{{idx+1}}].innerText.trim();
                    {% endfor %}
                    let statusTd = cells[cells.length-1];
                    statusTd.innerText = "Đang xử lý...";
                    statusTd.className = "status-processing";
                    let response = await fetch("/process_row", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({row: rowData, idx: i-1})
                    });
                    let data = await response.json();
                    if(data.status === "success"){
                        statusTd.innerText = "✔️ Thành công";
                        statusTd.className = "status-success";
                    }else{
                        statusTd.innerText = "❌ " + (data.msg || "Lỗi");
                        statusTd.className = "status-fail";
                    }
                }
                runBtn.disabled = false;
                alert("Xử lý hoàn tất!");
            }
        }
    </script>
</body>
</html>
